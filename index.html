import React, { useEffect, useState, useRef } from "react";

// TravelAgencyApp.jsx
// A single-file React component (tailwind-first) that demonstrates a realtime travel agency front-end.
// Features:
// - Browse curated tourist places in India with cost, accommodations, and sample packages
// - Search, filter, and sort
// - Real-time simulated updates (price changes, availability) using a mock WebSocket
// - Package builder and booking cart with discount rules
// - Admin-style panel to push "live" updates (simulated)

export default function TravelAgencyApp() {
  const initialPlaces = [
    {
      id: "jaipur",
      name: "Jaipur, Rajasthan",
      region: "North",
      pricePerPerson: 8500,
      durationDays: 3,
      highlights: ["Amber Fort", "City Palace", "Hawa Mahal"],
      accommodations: [
        { tier: "Budget", pricePerNight: 1200, name: "Heritage Inn" },
        { tier: "Comfort", pricePerNight: 2600, name: "Royal Stay" },
      ],
      availability: 12,
      img: "https://picsum.photos/seed/jaipur/800/500",
    },
    {
      id: "goa",
      name: "Goa Beaches",
      region: "West",
      pricePerPerson: 7000,
      durationDays: 4,
      highlights: ["Calangute", "Fort Aguada", "Water Sports"],
      accommodations: [
        { tier: "Budget", pricePerNight: 1500, name: "Sea Breeze" },
        { tier: "Luxury", pricePerNight: 5200, name: "Blue Bay Resort" },
      ],
      availability: 20,
      img: "https://picsum.photos/seed/goa/800/500",
    },
    {
      id: "manali",
      name: "Manali, Himachal",
      region: "North",
      pricePerPerson: 9500,
      durationDays: 5,
      highlights: ["Solang Valley", "Hadimba Temple", "Rohtang Pass"],
      accommodations: [
        { tier: "Comfort", pricePerNight: 2000, name: "Pine View" },
        { tier: "Luxury", pricePerNight: 6000, name: "Snow Crest" },
      ],
      availability: 6,
      img: "https://picsum.photos/seed/manali/800/500",
    },
    {
      id: "varanasi",
      name: "Varanasi, Uttar Pradesh",
      region: "East",
      pricePerPerson: 6000,
      durationDays: 2,
      highlights: ["Ghats", "Ganga Aarti", "Sarnath"],
      accommodations: [
        { tier: "Budget", pricePerNight: 900, name: "Ghat View Lodge" },
        { tier: "Comfort", pricePerNight: 2300, name: "Riverine Hotel" },
      ],
      availability: 15,
      img: "https://picsum.photos/seed/varanasi/800/500",
    },
    {
      id: "kerala",
      name: "Kerala Backwaters",
      region: "South",
      pricePerPerson: 11000,
      durationDays: 4,
      highlights: ["Alleppey Houseboat", "Spice Plantations", "Ayurvedic Spa"],
      accommodations: [
        { tier: "Comfort", pricePerNight: 3200, name: "Backwater Retreat" },
        { tier: "Luxury", pricePerNight: 7500, name: "Casa de Lago" },
      ],
      availability: 8,
      img: "https://picsum.photos/seed/kerala/800/500",
    },
  ];

  const [places, setPlaces] = useState(initialPlaces);
  const [query, setQuery] = useState("");
  const [regionFilter, setRegionFilter] = useState("all");
  const [cart, setCart] = useState([]);
  const [selectedPlace, setSelectedPlace] = useState(null);
  const [sortBy, setSortBy] = useState("recommended");
  const [showAdmin, setShowAdmin] = useState(false);
  const wsRef = useRef(null);

  // Discount rules: 10% off for 2-3 bookings, 15% for 4+, plus occasional package discounts on places
  const calculateTotals = () => {
    const subtotal = cart.reduce((s, c) => s + c.totalPrice, 0);
    let discount = 0;
    if (cart.length >= 4) discount += 0.15;
    else if (cart.length >= 2) discount += 0.10;

    // additional per-item package discounts
    let packageDiscountSum = cart.reduce((s, c) => s + (c.packageDiscount || 0), 0);

    const discountAmount = subtotal * discount + packageDiscountSum;
    const total = subtotal - discountAmount;
    return { subtotal, discountAmount, total };
  };

  // Mock realtime: simulate price changes and availability updates every 7s
  useEffect(() => {
    // mock websocket connection
    wsRef.current = {
      send: (msg) => {
        // when admin sends an update, we apply it
        const data = JSON.parse(msg);
        if (data.type === "admin_update") {
          setPlaces((p) => p.map((pl) => (pl.id === data.id ? { ...pl, ...data.payload } : pl)));
        }
      },
      close: () => {},
    };

    const iv = setInterval(() => {
      setPlaces((prev) => {
        // randomly pick a place and alter price or availability
        const i = Math.floor(Math.random() * prev.length);
        const changePrice = Math.random() > 0.5;
        const newPlaces = [...prev];
        const item = { ...newPlaces[i] };
        if (changePrice) {
          // 5-12% fluctuation
          const factor = 1 + (Math.random() * (Math.random() > 0.5 ? 0.12 : -0.08));
          item.pricePerPerson = Math.max(800, Math.round(item.pricePerPerson * factor));
        } else {
          // change availability a bit
          item.availability = Math.max(0, item.availability + (Math.random() > 0.5 ? -2 : 2));
        }
        newPlaces[i] = item;
        return newPlaces;
      });
    }, 7000);

    return () => clearInterval(iv);
  }, []);

  useEffect(() => {
    // simple sort
    setPlaces((p) => {
      const copy = [...p];
      if (sortBy === "price_low") copy.sort((a, b) => a.pricePerPerson - b.pricePerPerson);
      if (sortBy === "price_high") copy.sort((a, b) => b.pricePerPerson - a.pricePerPerson);
      if (sortBy === "availability") copy.sort((a, b) => b.availability - a.availability);
      return copy;
    });
  }, [sortBy]);

  const filtered = places.filter((pl) => {
    if (regionFilter !== "all" && pl.region !== regionFilter) return false;
    if (query && !(`${pl.name} ${pl.highlights.join(' ')}`).toLowerCase().includes(query.toLowerCase())) return false;
    return true;
  });

  function addToCart(place, nights = place.durationDays, accom = place.accommodations[0]) {
    const base = place.pricePerPerson;
    const accomCost = accom.pricePerNight * nights;
    const qty = 1; // booking units
    // package discount examples: seasonal 1000 off for select places
    const packageDiscount = place.packageDiscount || 0;
    const totalPrice = base * qty + accomCost;
    setCart((c) => [...c, { id: place.id + '-' + Date.now(), placeId: place.id, title: place.name, nights, accom, qty, totalPrice, packageDiscount }]);
  }

  function removeFromCart(uid) {
    setCart((c) => c.filter((x) => x.id !== uid));
  }

  function adminPushUpdate(id, payload) {
    // send via mock ws
    if (wsRef.current) wsRef.current.send(JSON.stringify({ type: "admin_update", id, payload }));
  }

  // UI
  return (
    <div className="min-h-screen bg-slate-50 text-slate-900 p-6">
      <div className="max-w-6xl mx-auto">
        <header className="flex items-center justify-between mb-6">
          <div>
            <h1 className="text-3xl font-extrabold">BharatJourneys — Real-time Travel Agency</h1>
            <p className="text-sm text-slate-600">Browse travel packages across India • Live price & availability updates</p>
          </div>
          <div className="flex gap-3 items-center">
            <input value={query} onChange={(e)=>setQuery(e.target.value)} placeholder="Search places or highlights..." className="px-3 py-2 border rounded-md" />
            <select value={regionFilter} onChange={(e)=>setRegionFilter(e.target.value)} className="px-3 py-2 border rounded-md">
              <option value="all">All regions</option>
              <option value="North">North</option>
              <option value="South">South</option>
              <option value="East">East</option>
              <option value="West">West</option>
            </select>
            <select value={sortBy} onChange={(e)=>setSortBy(e.target.value)} className="px-3 py-2 border rounded-md">
              <option value="recommended">Recommended</option>
              <option value="price_low">Price: Low to High</option>
              <option value="price_high">Price: High to Low</option>
              <option value="availability">Availability</option>
            </select>
            <button onClick={()=>setShowAdmin(s=>!s)} className="px-3 py-2 bg-slate-800 text-white rounded-md">Admin</button>
          </div>
        </header>

        <main className="grid grid-cols-3 gap-6">
          <section className="col-span-2">
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
              {filtered.map((pl) => (
                <article key={pl.id} className="bg-white p-4 rounded-xl shadow-sm flex gap-4">
                  <img src={pl.img} alt={pl.name} className="w-40 h-28 object-cover rounded-md" />
                  <div className="flex-1">
                    <h3 className="font-bold text-lg">{pl.name}</h3>
                    <div className="text-sm text-slate-600">{pl.highlights.join(' • ')}</div>
                    <div className="mt-2 flex items-center justify-between">
                      <div>
                        <div className="text-sm">{pl.durationDays} days • Availability: <span className={pl.availability > 5 ? 'text-green-600 font-semibold' : 'text-amber-600 font-semibold'}>{pl.availability}</span></div>
                        <div className="text-xl font-extrabold">₹{pl.pricePerPerson.toLocaleString()}</div>
                      </div>
                      <div className="flex flex-col gap-2">
                        <button onClick={() => setSelectedPlace(pl)} className="px-3 py-2 bg-indigo-600 text-white rounded-md">View</button>
                        <button onClick={() => addToCart(pl)} className="px-3 py-2 border rounded-md">Quick Book</button>
                      </div>
                    </div>
                  </div>
                </article>
              ))}
            </div>
          </section>

          <aside className="col-span-1">
            <div className="bg-white p-4 rounded-xl shadow-sm mb-4">
              <h4 className="font-bold">Your Cart</h4>
              {cart.length === 0 && <div className="text-sm text-slate-500 mt-2">No bookings yet. Add a package to start.</div>}
              <ul className="mt-2 space-y-2">
                {cart.map((c) => (
                  <li key={c.id} className="flex justify-between items-center">
                    <div>
                      <div className="font-semibold">{c.title}</div>
                      <div className="text-sm text-slate-500">{c.nights} nights • {c.accom.name}</div>
                    </div>
                    <div className="text-right">
                      <div>₹{c.totalPrice.toLocaleString()}</div>
                      <button onClick={() => removeFromCart(c.id)} className="text-sm text-red-600">Remove</button>
                    </div>
                  </li>
                ))}
              </ul>
              <div className="mt-4 border-t pt-3">
                <CartSummary calculateTotals={calculateTotals} />
                <div className="mt-3 flex gap-2">
                  <button onClick={() => alert('Implement checkout / payment integration in production')} className="flex-1 px-3 py-2 bg-green-600 text-white rounded-md">Proceed to Pay</button>
                  <button onClick={() => { setCart([]); }} className="px-3 py-2 border rounded-md">Clear</button>
                </div>
              </div>
            </div>

            <div className="bg-white p-4 rounded-xl shadow-sm">
              <h4 className="font-bold">Package Builder (demo)</h4>
              <p className="text-sm text-slate-500">Select a place to open builder and customize nights / accommodation.</p>
              <div className="mt-3">
                <button onClick={() => setSelectedPlace(places[0])} className="px-3 py-2 border rounded-md mr-2">Open Jaipur</button>
                <button onClick={() => setSelectedPlace(places[1])} className="px-3 py-2 border rounded-md mr-2">Open Goa</button>
              </div>
            </div>
          </aside>
        </main>

        {/* Selected place modal / builder */}
        {selectedPlace && (
          <div className="fixed inset-0 bg-black/40 flex items-center justify-center p-4">
            <div className="bg-white w-full max-w-3xl rounded-xl p-6 relative">
              <button onClick={() => setSelectedPlace(null)} className="absolute right-4 top-4 text-slate-600">Close</button>
              <div className="flex gap-6">
                <img src={selectedPlace.img} className="w-64 h-40 object-cover rounded-md" />
                <div>
                  <h2 className="text-2xl font-bold">{selectedPlace.name}</h2>
                  <div className="text-sm text-slate-600">{selectedPlace.highlights.join(' • ')}</div>
                  <div className="mt-3 text-lg font-extrabold">₹{selectedPlace.pricePerPerson.toLocaleString()} per person</div>

                  <PackageBuilder place={selectedPlace} onAdd={(cfg)=>{ addToCart(selectedPlace, cfg.nights, cfg.accom); setSelectedPlace(null); }} />
                </div>
              </div>
            </div>
          </div>
        )}

        {/* Admin panel (simulated) */}
        {showAdmin && (
          <div className="fixed left-6 bottom-6 bg-white p-4 rounded-xl shadow-lg w-96">
            <h4 className="font-bold">Admin — Push Live Update</h4>
            <div className="text-sm text-slate-500 mb-3">Select a place and change price/availability (simulated realtime push)</div>
            {places.map((pl) => (
              <AdminRow key={pl.id} place={pl} onUpdate={(payload)=> adminPushUpdate(pl.id, payload)} />
            ))}
          </div>
        )}

      </div>
    </div>
  );
}

function CartSummary({ calculateTotals }) {
  const { subtotal, discountAmount, total } = calculateTotals();
  return (
    <div>
      <div className="flex justify-between"><div className="text-sm text-slate-500">Subtotal</div><div className="font-semibold">₹{subtotal.toLocaleString()}</div></div>
      <div className="flex justify-between"><div className="text-sm text-slate-500">Discounts</div><div className="font-semibold">-₹{Math.round(discountAmount).toLocaleString()}</div></div>
      <div className="flex justify-between mt-1 text-lg font-bold"><div>Total</div><div>₹{Math.round(total).toLocaleString()}</div></div>
    </div>
  );
}

function PackageBuilder({ place, onAdd }) {
  const [nights, setNights] = useState(place.durationDays);
  const [accIdx, setAccIdx] = useState(0);

  const accom = place.accommodations[accIdx];
  const total = place.pricePerPerson + accom.pricePerNight * nights;

  return (
    <div className="mt-4">
      <div className="text-sm">Nights</div>
      <input type="range" min={1} max={10} value={nights} onChange={(e)=>setNights(Number(e.target.value))} />
      <div className="flex gap-2 mt-2">
        {place.accommodations.map((a, i) => (
          <button key={a.name} onClick={() => setAccIdx(i)} className={"px-2 py-1 rounded-md border " + (i===accIdx ? 'bg-indigo-600 text-white' : '')}>{a.tier}</button>
        ))}
      </div>

      <div className="mt-3">
        <div className="text-sm text-slate-600">Accommodation: {accom.name} • ₹{accom.pricePerNight}/night</div>
        <div className="mt-2 text-xl font-bold">Est. Total: ₹{total.toLocaleString()}</div>
        <div className="mt-3 flex gap-2">
          <button onClick={() => onAdd({ nights, accom })} className="px-3 py-2 bg-emerald-600 text-white rounded-md">Add to Cart</button>
        </div>
      </div>
    </div>
  );
}

function AdminRow({ place, onUpdate }) {
  const [price, setPrice] = useState(place.pricePerPerson);
  const [avail, setAvail] = useState(place.availability);
  return (
    <div className="flex items-center gap-2 mb-2">
      <div className="flex-1">
        <div className="font-semibold">{place.name}</div>
        <div className="text-sm text-slate-500">Price: ₹{place.pricePerPerson} • Avail: {place.availability}</div>
      </div>
      <div className="flex flex-col gap-1">
        <input value={price} onChange={(e)=>setPrice(Number(e.target.value))} className="px-2 py-1 border rounded-md w-28" />
        <input value={avail} onChange={(e)=>setAvail(Number(e.target.value))} className="px-2 py-1 border rounded-md w-28" />
        <button onClick={()=>onUpdate({ pricePerPerson: price, availability: avail })} className="px-2 py-1 bg-indigo-600 text-white rounded-md">Push</button>
      </div>
    </div>
  );
}
